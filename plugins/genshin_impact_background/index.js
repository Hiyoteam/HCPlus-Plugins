(function () {
  var people_list = [
    {
      "city": {
        "name": "mondstadt",
        "title": "蒙德城"
      },
      "list": [
        {
          "name": "禁用",
          "title": "disable"
        },
        {
          "name": "琴",
          "title": "qin"
        },
        {
          "name": "安柏",
          "title": "anbai"
        },
        {
          "name": "丽莎",
          "title": "lisha"
        },
        {
          "name": "凯亚",
          "title": "kaiya"
        },
        {
          "name": "芭芭拉",
          "title": "babala"
        },
        {
          "name": "迪卢克",
          "title": "diluke"
        },
        {
          "name": "雷泽",
          "title": "leize"
        },
        {
          "name": "温迪",
          "title": "wendi"
        },
        {
          "name": "可莉",
          "title": "keli"
        },
        {
          "name": "班尼特",
          "title": "bannite"
        },
        {
          "name": "诺艾尔",
          "title": "nuoaier"
        },
        {
          "name": "菲谢尔",
          "title": "feixieer"
        },
        {
          "name": "砂糖",
          "title": "shatang"
        },
        {
          "name": "莫娜",
          "title": "mona"
        },
        {
          "name": "迪奥娜",
          "title": "diaona"
        },
        {
          "name": "阿贝多",
          "title": "abeiduo"
        },
        {
          "name": "罗莎莉亚",
          "title": "luoshaliya"
        },
        {
          "name": "优菈",
          "title": "youla"
        },
        {
          "name": "埃洛伊",
          "title": "ailuoyi"
        },
        {
          "name": "米卡",
          "title": "mika"
        }
      ]
    },
    {
      "city": {
        "name": "liyue",
        "title": "璃月港"
      },
      "list": [
        {
          "name": "魈",
          "title": "xiao"
        },
        {
          "name": "北斗",
          "title": "beidou"
        },
        {
          "name": "凝光",
          "title": "ningguang"
        },
        {
          "name": "香菱",
          "title": "xiangling"
        },
        {
          "name": "行秋",
          "title": "xingqiu"
        },
        {
          "name": "重云",
          "title": "zhongyun"
        },
        {
          "name": "刻晴",
          "title": "keqing"
        },
        {
          "name": "七七",
          "title": "qiqi"
        },
        {
          "name": "达达利亚",
          "title": "dadaliya"
        },
        {
          "name": "钟离",
          "title": "zhongli"
        },
        {
          "name": "辛焱",
          "title": "xinyan"
        },
        {
          "name": "甘雨",
          "title": "ganyu"
        },
        {
          "name": "胡桃",
          "title": "hutao"
        },
        {
          "name": "烟绯",
          "title": "yanfei"
        },
        {
          "name": "申鹤",
          "title": "shenhe"
        },
        {
          "name": "云堇",
          "title": "yunjin"
        },
        {
          "name": "夜兰",
          "title": "yelan"
        },
        {
          "name": "瑶瑶",
          "title": "yaoyao"
        },
        {
          "name": "白术",
          "title": "baizhu"
        },
        {
          "name": "闲云",
          "title": "xianyun"
        },
        {
          "name": "嘉明",
          "title": "jiaming"
        }
      ]
    },
    {
      "city": {
        "name": "inazuma",
        "title": "稻妻城"
      },
      "list": [
        {
          "name": "神里绫华",
          "title": "shenlilinghua"
        },
        {
          "name": "枫原万叶",
          "title": "fengyuanwanye"
        },
        {
          "name": "宵宫",
          "title": "xiaogong"
        },
        {
          "name": "早柚",
          "title": "zaoyou"
        },
        {
          "name": "雷电将军",
          "title": "leidianjiangjun"
        },
        {
          "name": "九条裟罗",
          "title": "jiutiaoshaluo"
        },
        {
          "name": "珊瑚宫心海",
          "title": "shanhugongxinhai"
        },
        {
          "name": "托马",
          "title": "tuoma"
        },
        {
          "name": "荒泷一斗",
          "title": "huanglongyidou"
        },
        {
          "name": "五郎",
          "title": "wulang"
        },
        {
          "name": "八重神子",
          "title": "bazhongshenzi"
        },
        {
          "name": "神里绫人",
          "title": "shenlilingren"
        },
        {
          "name": "久岐忍",
          "title": "jiuqiren"
        },
        {
          "name": "鹿野院平藏",
          "title": "luyeyuanpingcang"
        },
        {
          "name": "绮良良",
          "title": "qiliangliang"
        }
      ]
    },
    {
      "city": {
        "name": "sumeru",
        "title": "须弥城"
      },
      "list": [
        {
          "name": "提纳里",
          "title": "tinali"
        },
        {
          "name": "柯莱",
          "title": "kelai"
        },
        {
          "name": "多莉",
          "title": "duoli"
        },
        {
          "name": "赛诺",
          "title": "sainuo"
        },
        {
          "name": "坎蒂丝",
          "title": "kandisi"
        },
        {
          "name": "妮露",
          "title": "nilu"
        },
        {
          "name": "纳西妲",
          "title": "naxida"
        },
        {
          "name": "莱依拉",
          "title": "laiyila"
        },
        {
          "name": "流浪者",
          "title": "liulangzhe"
        },
        {
          "name": "珐露珊",
          "title": "falushan"
        },
        {
          "name": "艾尔海森",
          "title": "aierhaisen"
        },
        {
          "name": "迪希雅",
          "title": "dixiya"
        },
        {
          "name": "卡维",
          "title": "kawei"
        }
      ]
    },
    {
      "city": {
        "name": "fontaine",
        "title": "枫丹廷"
      },
      "list": [
        {
          "name": "林尼",
          "title": "linni"
        },
        {
          "name": "琳妮特",
          "title": "linnite"
        },
        {
          "name": "菲米尼",
          "title": "feimini"
        },
        {
          "name": "那维莱特",
          "title": "naweilaite"
        },
        {
          "name": "莱欧斯利",
          "title": "laiousili"
        },
        {
          "name": "夏洛蒂",
          "title": "xialuodi"
        },
        {
          "name": "芙宁娜",
          "title": "funingna"
        },
        {
          "name": "娜维娅",
          "title": "naweiya"
        },
        {
          "name": "夏沃蕾",
          "title": "xiawolei"
        }
      ]
    }
  ].map(e => e.list.map(u => ({ ...u, city: e.city }))).flat();

  var host = `${location.protocol}//${location.hostname}/plugins/genshin_impact_background/`;

  var selected_people = localStorage['_gs_cache_name'] || 'hutao';
  var opacity = localStorage['_gs_bg_opacity'] || '30';
  var setPeople = (e) => {
    setImage(selected_people = e);
  }
  var find_people = (e) => {
    let people = people_list.find(y => y.title == e);
    if (!people) return { find: false };
    return {
      ...people,
      path: {
        pc: host + people.title + '.png',
        phone: host + people.title + '.2.png'
      },
      find: true,
    }
  }
  var img_obj = {},
    container_obj = {};
  var cache_obj = {};
  var setOpacity = (e) => {
    img_obj.style.opacity = e + '%';
    opacity = localStorage['_gs_bg_opacity'] = e;
  };
  /***************************************************** */
  function hookFunction(hook, func) {
    // console.log(window[hook], func);
    var oldonload = window[hook];
    if (typeof window[hook] != "function") {
      window[hook] = func;
    } else {
      window[hook] = function () {
        oldonload();
        func();
      };
    }
  }
  function injectcss(url, id) {
    var link = document.createElement("link");
    if (id) link.id = id;
    document.head.appendChild(link);
    link.setAttribute("rel", "stylesheet");
    link.setAttribute("href", url);
    link.setAttribute("type", "text/css");
  }
  /******************************************************* */
  function getBase64Image(img) {
    var canvas = document.createElement("canvas");
    canvas.width = img.width;
    canvas.height = img.height;
    var ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, img.width, img.height);
    var dataURL = canvas.toDataURL("image/png");
    return dataURL;
    // return dataURL.replace("data:image/png;base64,", "");
  }

  function ToBase64(src) {
    return new Promise((_true, _false) => {
      var img = document.createElement("img");
      img.src = src;
      // console.log('tobase64')
      img.crossOrigin = "anonymous";
      img.onload = () => {
        _true(getBase64Image(img));
        // console.log('tobase64', getBase64Image(img))
      };
      img.onerror = () => {
        _false(false);
      };
    });
  }
  /******************************************************** */
  function getURLName(url) {
    var cleanUrl = url.split('?')[0]; // 去掉请求参数部分
    var fileName = cleanUrl.substring(cleanUrl.lastIndexOf('/') + 1); // 获取文件名部分
    return fileName;
  }
  async function useCache(name) {

    let conf = {
      cache: localStorage['_gs_cache'] == 'true',
      cache_name: localStorage['_gs_cache_name'] || false,
      cache_pc_base64: localStorage['_gs_cache_pc'],
      cache_phone: localStorage['_gs_cache_phone'],
    };
    // 
    if (!conf.cache || !conf.cache_name || !conf.cache_pc_base64 || !conf.cache_phone || conf.cache_name != name) {
      localStorage['_gs_cache'] = 'true';
      localStorage['_gs_cache_name'] = name;
      try {
        conf.cache_pc_base64 = localStorage['_gs_cache_pc'] = await getImage(name, '0');
        conf.cache_phone = localStorage['_gs_cache_phone'] = await getImage(name, '1');
      }
      catch {
        conf.cache = false; localStorage['_gs_cache'] = 'false';
        conf.cache_name = localStorage['_gs_cache_name'] = '';
      }
      // console.log(conf, name);
    }
    return conf;
  }
  async function getImage(name, mode) {
    let people = find_people(name);
    // console.log('getimage', people);
    if (!people.find)
      people = people_list[0];
    return await ToBase64(`${host}asset/${people.city.name}/${name}${mode == '0' ? '.png' : '.2.png'}`);
  }
  async function getPeopleImage(name, mode) {
    if (name == 'disable') return '';
    let cache = await useCache(name);
    return mode == '0' ? cache.cache_pc_base64 : cache.cache_phone;
  }
  function aspectRatio() {
    // 获取网页正文的宽度和高度
    let body = container_obj;
    let width = body.offsetWidth;
    let height = body.offsetHeight;

    // 计算宽高比
    let aspectRatio = width / height;
    // console.log(width, height, aspectRatio);
    // 判断宽高比
    if (aspectRatio > 1) {
      //console.log("网页宽屏幕显示");
      return "k";
    } else if (aspectRatio < 1) {
      // console.log("网页竖屏幕显示");
      return "s";
    } else {
      //console.log("网页正方形显示");
      return "z";
    }
  }

  async function setImage(name) {
    let res = aspectRatio();
    switch (res) {
      case "k":
      case "z":
        img_obj.src = await getPeopleImage(name, '0');
        break;
      case "s":
        img_obj.src = await getPeopleImage(name, '1');
        break;
    }
  }
  function createOption(text, options, onchange = (e) => { }, init = (e) => e) {
    let p = document.createElement("p");
    p.appendChild(
      ((e) =>
        !!(e = document.createElement("span")) && !!(e.innerText = text) && e)()
    );
    p.appendChild(document.createElement("br"));
    p.appendChild(
      ((e) =>
        !!(e = document.createElement("select")) &&
        !options.forEach((j) => e.appendChild(new Option(j[0], j[1]))) &&
        !!(e.onchange = onchange) &&
        !!init(e) &&
        e)()
    );
    return p;
  }
  function injectSelect(text, options, onchange, init) {
    document
      .querySelector("#sidebar-content")
      .insertBefore(
        createOption(text, options, onchange, init),
        document.querySelector("#tunnel-selector").nextElementSibling
      );
  }
  function init() {
    let div = document.createElement("div");
    div.className = "background";
    let image = document.createElement("img");
    div.appendChild(image);
    img_obj = image;
    container_obj = div;

    document.body.appendChild(div);
    injectSelect('Background Image', people_list.map(e => [e.name, e.title]), (e) => {
      let val = e.target.value;
      setPeople(val);
    }, (e) => {
      e.value = selected_people;
      return e;
    });
    injectSelect('Opacity', [...Array(11)].map((e, i) => [(i * 10).toString() + '%', i * 10]), (e) => {
      setOpacity(e.target.value.toString());
    }, (e) => {
      e.value = opacity;
      return e;
    });
    injectSelect('Background Layer', [
      ['Before', '0'],
      ['After', '1']
    ], (e) => {
      container_obj.style.zIndex = (localStorage['_gs_bg_zindex'] = e.target.value) == '0' ? '-9999999' : '9999999';
    }, (e) => {
      container_obj.style.zIndex = (e.value = localStorage['_gs_bg_zindex'] || '1') == '0' ? '-9999999' : '9999999';
      return e;
    });
  }
  injectcss(host + "style.css");
  // console.log(people_list);
  hookFunction("onload", () => {
    init();
    setImage(selected_people);
    setOpacity(opacity);
  });
  hookFunction('onresize', () => setImage(selected_people));
})();
